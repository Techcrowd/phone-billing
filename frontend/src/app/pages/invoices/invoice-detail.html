@if (invoice(); as inv) {
  <!-- Header -->
  <div class="flex items-center gap-3 mb-6">
    <a
      routerLink="/invoices"
      class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors shrink-0"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </a>
    <div class="flex-1 min-w-0">
      <h2 class="text-lg sm:text-xl font-bold text-gray-900 truncate">
        {{ formatPeriod(inv.period) }}
      </h2>
      <p class="text-sm text-gray-500">{{ totalItems() }} položek</p>
    </div>
    <div class="text-right shrink-0">
      <p class="text-xl sm:text-2xl font-bold text-gray-900">
        {{ inv.total_with_vat | currency: 'CZK' : 'symbol' : '1.0-0' : 'cs' }}
      </p>
      <p class="text-xs text-gray-400">
        {{ inv.total_without_vat | currency: 'CZK' : 'symbol' : '1.0-0' : 'cs' }} bez DPH
      </p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex gap-1 mb-5 bg-gray-100 rounded-lg p-1 w-fit">
    <button
      (click)="activeTab.set('breakdown')"
      class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
      [class.bg-white]="activeTab() === 'breakdown'"
      [class.text-gray-900]="activeTab() === 'breakdown'"
      [class.shadow-sm]="activeTab() === 'breakdown'"
      [class.text-gray-500]="activeTab() !== 'breakdown'"
    >
      Rozpis
    </button>
    <button
      (click)="activeTab.set('pdf')"
      class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
      [class.bg-white]="activeTab() === 'pdf'"
      [class.text-gray-900]="activeTab() === 'pdf'"
      [class.shadow-sm]="activeTab() === 'pdf'"
      [class.text-gray-500]="activeTab() !== 'pdf'"
      [disabled]="!inv.file_path"
    >
      PDF
    </button>
  </div>

  <!-- Tab: Rozpis -->
  @if (activeTab() === 'breakdown') {
    @for (group of inv.groups; track group.group_name) {
      <div
        class="bg-white rounded-xl shadow-sm border mb-4 overflow-hidden"
        [class.border-gray-100]="group.group_id"
        [class.border-amber-200]="!group.group_id"
      >
        <!-- Group header -->
        <div
          class="px-3 sm:px-5 py-3 border-b border-gray-100"
          [class.bg-gray-50]="group.group_id"
          [class.bg-amber-50]="!group.group_id"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2.5">
              @if (!group.group_id) {
                <div class="w-2 h-2 rounded-full bg-amber-400"></div>
              } @else {
                <div class="w-2 h-2 rounded-full bg-pink-400"></div>
              }
              <span class="font-semibold text-sm text-gray-800">{{ group.group_name }}</span>
              <span class="text-xs text-gray-400">{{ group.items.length }} položek</span>
            </div>
            <!-- Payment toggle -->
            @if (group.payment) {
              <button
                (click)="togglePayment(group.payment!.id, !group.payment!.is_paid)"
                class="text-xs font-medium px-3 py-1 rounded-full transition-colors"
                [class.bg-emerald-50]="group.payment!.is_paid"
                [class.text-emerald-600]="group.payment!.is_paid"
                [class.bg-red-50]="!group.payment!.is_paid"
                [class.text-red-500]="!group.payment!.is_paid"
              >
                {{ group.payment!.is_paid ? 'Zaplaceno' : 'Nezaplaceno' }}
              </button>
            }
          </div>
          <!-- Group DPH summary -->
          <div
            class="grid grid-cols-[1fr_auto_auto] sm:grid-cols-[1fr_auto_auto_auto] gap-x-4 mt-2 text-xs"
          >
            <div></div>
            <div class="text-right text-gray-500">
              <span class="font-medium">
                {{ group.total_without_vat | currency: 'CZK' : 'symbol' : '1.0-0' : 'cs' }}
              </span>
              <span class="text-gray-400 ml-1">bez DPH</span>
            </div>
            @if (group.total_vat_exempt > 0) {
              <div class="text-right text-gray-500 hidden sm:block">
                <span class="font-medium">
                  {{ group.total_vat_exempt | currency: 'CZK' : 'symbol' : '1.0-0' : 'cs' }}
                </span>
                <span class="text-gray-400 ml-1">osv.</span>
              </div>
            } @else {
              <div class="hidden sm:block"></div>
            }
            <div class="text-right">
              <span class="font-bold text-gray-800">
                {{ group.total_with_vat | currency: 'CZK' : 'symbol' : '1.0-0' : 'cs' }}
              </span>
              <span class="text-gray-400 ml-1">s DPH</span>
            </div>
          </div>
        </div>
        <!-- Column headers -->
        <div
          class="grid grid-cols-[minmax(0,1fr)_auto_auto] sm:grid-cols-[minmax(0,1fr)_100px_80px_100px] gap-x-2 px-3 sm:px-5 py-1.5 bg-gray-50/50 text-[10px] font-semibold text-gray-400 uppercase tracking-wider border-b border-gray-50"
        >
          <div>Číslo / služba</div>
          <div class="text-right">bez DPH</div>
          <div class="text-right hidden sm:block">osv. DPH</div>
          <div class="text-right">s DPH</div>
        </div>
        <!-- Items -->
        @for (item of group.items; track item.service_id) {
          <div
            class="grid grid-cols-[minmax(0,1fr)_auto_auto] sm:grid-cols-[minmax(0,1fr)_100px_80px_100px] gap-x-2 items-center px-3 sm:px-5 py-2.5 hover:bg-gray-50/50 transition-colors border-b border-gray-50 last:border-0"
          >
            <div class="flex items-center gap-2 min-w-0">
              <code
                class="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded font-mono shrink-0"
              >
                {{ formatIdentifier(item.identifier) }}
              </code>
              <span class="text-xs text-gray-500 truncate">{{ item.label || '' }}</span>
            </div>
            <div class="text-right text-sm tabular-nums text-gray-600">
              {{ item.amount_without_vat | currency: 'CZK' : 'symbol' : '1.0-0' : 'cs' }}
            </div>
            <div class="text-right text-sm tabular-nums text-gray-400 hidden sm:block">
              @if (item.amount_vat_exempt > 0) {
                {{ item.amount_vat_exempt | currency: 'CZK' : 'symbol' : '1.0-0' : 'cs' }}
              } @else {
                &mdash;
              }
            </div>
            <div class="text-right text-sm font-semibold tabular-nums">
              {{ item.amount_with_vat | currency: 'CZK' : 'symbol' : '1.0-0' : 'cs' }}
            </div>
          </div>
        }
      </div>
    }

    <!-- Actions -->
    <div class="flex gap-3 mt-6">
      <button
        (click)="generatePayments()"
        class="px-5 py-2.5 bg-pink-600 text-white rounded-lg hover:bg-pink-700 text-sm font-medium transition-colors"
      >
        Generovat platby
      </button>
    </div>
    @if (message()) {
      <p class="mt-3 text-sm text-emerald-600 bg-emerald-50 px-4 py-2.5 rounded-lg">
        {{ message() }}
      </p>
    }
    @if (error()) {
      <p class="mt-3 text-sm text-red-600 bg-red-50 px-4 py-2.5 rounded-lg">{{ error() }}</p>
    }
  }

  <!-- Tab: PDF -->
  @if (activeTab() === 'pdf' && pdfUrl()) {
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <iframe [src]="pdfUrl()!" class="w-full border-0 h-[80vh]"></iframe>
    </div>
  }
}
